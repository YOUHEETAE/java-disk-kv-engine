# íë²„íŠ¸ ì»¤ë¸Œ ì¸ë±ìŠ¤ êµ¬í˜„ - ë¬¸ì œ í•´ê²° ê³¼ì •

> **% MAX_PAGE ë°©ì‹ì˜ í•œê³„ ë°œê²¬ê³¼ / RANGE_PER_PAGE ë°©ì‹ìœ¼ë¡œì˜ ì „í™˜**

---

## ëª©ì°¨

1. [ë°°ê²½](#-ë°°ê²½)
2. [1ì°¨ ì‹œë„: % MAX_PAGE](#-1ì°¨-ì‹œë„--maxpage)
3. [ì›ì¸ ë¶„ì„: íë²„íŠ¸ ê²½ê³„ ì í”„](#-ì›ì¸-ë¶„ì„-íë²„íŠ¸-ê²½ê³„-ì í”„)
4. [2ì°¨ ì‹œë„: / RANGE_PER_PAGE](#-2ì°¨-ì‹œë„--rangeperpag)
5. [delta ì‹¤ì¸¡ ë° ë³´ì •](#-delta-ì‹¤ì¸¡-ë°-ë³´ì •)
6. [ìµœì¢… ê²°ê³¼](#-ìµœì¢…-ê²°ê³¼)
7. [ë‚¨ì€ ê³¼ì œ](#-ë‚¨ì€-ê³¼ì œ)

---

## ğŸ¯ ë°°ê²½

GeoHash ì¸ë±ìŠ¤ì™€ ë™ì¼í•œ `SpatialIndex` ì¸í„°í˜ì´ìŠ¤ë¡œ íë²„íŠ¸ ì»¤ë¸Œë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

```java
public interface SpatialIndex {
    int toPageId(double lat, double lng);
    List<Integer> getPageIds(double lat, double lng, double radiusKm);
}
```

GeoHashëŠ” `neighbor()` ë¡œ ì¸ì ‘ ì…€ì„ ì§ì ‘ ì§€ì •í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
íë²„íŠ¸ëŠ” ê°’ì´ ì—°ì†ì ì´ë¼ `min ~ max` ë²”ìœ„ë¡œ PageIdë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.

---

## âŒ 1ì°¨ ì‹œë„: % MAX_PAGE

### êµ¬í˜„

```java
// GeoHashì™€ ë™ì¼í•œ ë°©ì‹
public int toPageId(double lat, double lng) {
    long h = HilbertCurve.encode(lat, lng);
    return (int)(h % MAX_PAGE);  // % 10,000
}

public List<Integer> getPageIds(...) {
    long center = HilbertCurve.encode(lat, lng);
    long delta = steps * steps;  // 268 * 268 = 71,824
    // minH ~ maxH ë²”ìœ„ì˜ % MAX_PAGE ì „ë¶€ ìˆ˜ì§‘
}
```

### ê²°ê³¼

```
í›„ë³´ ìˆ˜: 79,081ê±´  â† Full Scanê³¼ ë™ì¼
ê²°ê³¼:    0ê±´
```

### ì›ì¸

```
delta = 71,824
MAX_PAGE = 10,000

71,824 % 10,000 â†’ 0 ~ 9,999 ì „ë¶€ ì»¤ë²„
â†’ ëª¨ë“  PageId ì¡°íšŒ â†’ Full Scan é€€åŒ–
```

---

## ğŸ” ì›ì¸ ë¶„ì„: íë²„íŠ¸ ê²½ê³„ ì í”„

`% MAX_PAGE` ë¥¼ `/ RANGE_PER_PAGE` ë¡œ ë°”ê¾¸ê¸° ì „ì—,
íë²„íŠ¸ê°’ì´ ì‹¤ì œë¡œ ì–¼ë§ˆë‚˜ ì í”„í•˜ëŠ”ì§€ ì‹¤ì¸¡í–ˆìŠµë‹ˆë‹¤.

### ê°•ë‚¨ ì¢Œí‘œ ê¸°ì¤€ 8ë°©í–¥ ì‹¤ì¸¡

```
ì¤‘ì‹¬:     (37.4979, 127.0276) â†’ íë²„íŠ¸ê°’ 416,884,576

ë¶ìª½ 5km: íë²„íŠ¸ê°’ 416,820,955  ì°¨ì´      63,621  â† ì‘ìŒ
ë‚¨ìª½ 5km: íë²„íŠ¸ê°’ 405,179,802  ì°¨ì´  11,704,774  â† ê±°ëŒ€ ì í”„
ì„œìª½ 5km: íë²„íŠ¸ê°’ 416,621,082  ì°¨ì´     263,494
ë™ìª½ 5km: íë²„íŠ¸ê°’ 417,670,746  ì°¨ì´     786,170
ëŒ€ê° ë°©í–¥: ìµœëŒ€ ì°¨ì´           12,490,934
```

### ì™œ ë‚¨ìª½ ë°©í–¥ì—ì„œ ì í”„ê°€ ë°œìƒí•˜ë‚˜?

íë²„íŠ¸ ì»¤ë¸ŒëŠ” ì¬ê·€ì ìœ¼ë¡œ ì‚¬ë¶„ë©´ì„ íšŒì „/ë°˜ì „í•´ì„œ ë¶™ì…ë‹ˆë‹¤.
ì´ ì§€ì ì—ì„œ **í° ì‚¬ë¶„ë©´ ê²½ê³„**ë¥¼ ë„˜ê¸° ë•Œë¬¸ì— íë²„íŠ¸ê°’ì´ í¬ê²Œ ëœë‹ˆë‹¤.

```
ë¶ìª½ ì´ë™: ê°™ì€ ì‚¬ë¶„ë©´ ë‚´ë¶€ â†’ íë²„íŠ¸ê°’ ì—°ì†
ë‚¨ìª½ ì´ë™: ì‚¬ë¶„ë©´ ê²½ê³„ í†µê³¼ â†’ íë²„íŠ¸ê°’ ëŒ€í­ ì í”„
```

GeoHash(Z-order)ë„ ë™ì¼í•œ ë¬¸ì œê°€ ìˆì§€ë§Œ,
GeoHashëŠ” `neighbor()` ë¡œ ì…€ì„ ì§ì ‘ ì§€ì •í•˜ê¸° ë•Œë¬¸ì— ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤.

---

## âœ… 2ì°¨ ì‹œë„: / RANGE_PER_PAGE

### í•µì‹¬ ì•„ì´ë””ì–´

```
% MAX_PAGE â†’ íë²„íŠ¸ê°’ì„ 10,000ìœ¼ë¡œ ì ‘ì–´ë²„ë¦¼ â†’ ì—°ì†ì„± íŒŒê´´
/ RANGE_PER_PAGE â†’ íë²„íŠ¸ê°’ì„ 10,000 êµ¬ê°„ìœ¼ë¡œ ì„ í˜• ë¶„í•  â†’ ì—°ì†ì„± ë³´ì¡´
```

### êµ¬í˜„

```java
// íë²„íŠ¸ê°’ ì „ì²´ ë²”ìœ„: 2^30 â‰ˆ 10ì–µ
private static final long MAX_HILBERT = N * N;

// í˜ì´ì§€ í•˜ë‚˜ê°€ ë‹´ë‹¹í•˜ëŠ” íë²„íŠ¸ê°’ ë²”ìœ„
// 1,073,741,824 / 10,000 = 107,374
private static final long RANGE_PER_PAGE = MAX_HILBERT / MAX_PAGE;

public int toPageId(double lat, double lng) {
    long h = HilbertCurve.encode(lat, lng);
    int pageId = (int)(h / RANGE_PER_PAGE);
    return Math.min(pageId, MAX_PAGE - 1);
}
```

### % vs / ë¹„êµ

```
ì¤‘ì‹¬:    íë²„íŠ¸ê°’ 416,884,576
ë‚¨ìª½ 5km: íë²„íŠ¸ê°’ 405,179,802

% ë°©ì‹:  416,884,576 % 10,000 = 6,576
         405,179,802 % 10,000 = 9,802  â†’ PageId ì°¨ì´ 3,226

/ ë°©ì‹:  416,884,576 / 107,374 = 3,882
         405,179,802 / 107,374 = 3,773  â†’ PageId ì°¨ì´ 109
```

---

## ğŸ“ delta ì‹¤ì¸¡ ë° ë³´ì •

### getPageIds êµ¬í˜„

```java
public List<Integer> getPageIds(double lat, double lng, double radiusKm) {
    long centerH = HilbertCurve.encode(lat, lng);
    long steps = (long) Math.ceil(radiusKm / KM_PER_GRID);  // â‰ˆ 268
    long delta = steps * steps * 200;  // ì‹¤ì¸¡ ê¸°ë°˜

    long minH = Math.max(0, centerH - delta);
    long maxH = Math.min(MAX_HILBERT - 1, centerH + delta);

    int minPageId = (int)(minH / RANGE_PER_PAGE);
    int maxPageId = Math.min((int)(maxH / RANGE_PER_PAGE), MAX_PAGE - 1);

    List<Integer> pageIds = new ArrayList<>();
    for (int p = minPageId; p <= maxPageId; p++) {
        pageIds.add(p);
    }
    return pageIds;
}
```

### delta ë³´ì • ê³¼ì •

| delta | í›„ë³´ ìˆ˜ | ê²°ê³¼ | ë¹„ê³  |
|-------|--------|------|------|
| `steps * 2` | 8,393ê±´ | 0ê±´ | delta ë¶€ì¡± |
| `steps * steps * 2` | 22ê±´ | 19ê±´ | 8ê±´ ëˆ„ë½ |
| `steps * steps * 200` | 2,102ê±´ | 27ê±´ âœ… | ì‹¤ì¸¡ ìµœëŒ€ê°’ ì»¤ë²„ |

```
ì‹¤ì¸¡ ìµœëŒ€ delta:    12,490,934
steps * steps * 200: 14,364,800  â† ì»¤ë²„
```

---

## ğŸ“Š ìµœì¢… ê²°ê³¼

### HilbertBenchmark (79,081ê±´)

```
ì‚½ì…: 157ms
í›„ë³´ ìˆ˜ (ì›í˜• í•„í„°ë§ ì „): 2,102ê±´
ê²€ìƒ‰: 13ms
ê²°ê³¼: 27ê±´ âœ…  (Full Scanê³¼ ë™ì¼)
```

### 3ë°©í–¥ ë²¤ì¹˜ë§ˆí¬ ë¹„êµ

| ê±´ìˆ˜ | Full Scan | GeoHash | Hilbert |
|------|----------|---------|---------|
| 10,000 | 103ms | 0ms | 16ms |
| 79,081 | 417ms | 0ms | 0ms |
| 500,000 | 729ms | 5ms | 5ms |
| 1,000,000 | 1,257ms | 5ms | 16ms |

---

## ğŸ”® ë‚¨ì€ ê³¼ì œ

### ë™ì  delta

í˜„ì¬ deltaëŠ” **ê°•ë‚¨ ì¢Œí‘œ ê¸°ì¤€ ì‹¤ì¸¡ê°’** í•˜ë“œì½”ë”©ì…ë‹ˆë‹¤.

```java
// TODO: ì¢Œí‘œë§ˆë‹¤ íë²„íŠ¸ ê²½ê³„ ìœ„ì¹˜ê°€ ë‹¤ë¦„
// í˜„ì¬ëŠ” ê°•ë‚¨ ê¸°ì¤€ ì‹¤ì¸¡ê°’(steps * steps * 200) í•˜ë“œì½”ë”©
// ì‹¤ì œ ì„œë¹„ìŠ¤ ì ìš© ì‹œ ë™ì  delta ê³„ì‚° í•„ìš”
long delta = steps * steps * 200;
```

ë™ì  delta ê³„ì‚° ë°©í–¥:
```
1. ì¤‘ì‹¬ ì¢Œí‘œ â†’ íë²„íŠ¸ê°’ centerH
2. ë°˜ê²½ ê²½ê³„ 8ë°©í–¥ ì¢Œí‘œ â†’ íë²„íŠ¸ê°’ ê³„ì‚°
3. max(|centerH - ê²½ê³„Hi|) â†’ ì‹¤ì œ delta ì‚¬ìš©
```

### í›„ë³´ ìˆ˜ ìµœì í™”

```
GeoHash: 1,379ê±´ (169ê°œ ì…€ ì§ì ‘ ì§€ì •)
íë²„íŠ¸:  2,102ê±´ (PageId ì„ í˜• ë²”ìœ„)

ê²©ì ì¢Œí‘œ(x, y) ì§ì ‘ ìˆœíšŒ ë°©ì‹ìœ¼ë¡œ ì „í™˜ ì‹œ
â†’ GeoHash ìˆ˜ì¤€ìœ¼ë¡œ í›„ë³´ ìˆ˜ ê°ì†Œ ê°€ëŠ¥
```

---

## ğŸ“š ì°¸ê³ 

- [GeoHash êµ¬í˜„](../index/README.md)
- [ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼](../benchmark/README.md)
- [íë²„íŠ¸ ì»¤ë¸Œ ì‹œê°í™”](../../docs/hilbert_visual.html)
